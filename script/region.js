(()=>{function F(e){return e?e.type==="region"&&typeof e.id=="string"&&typeof e.rx=="number"&&typeof e.rz=="number"&&typeof e.dim=="number"&&!!e.javaEditionMap:!1}function x(e,t,r=Module.HEAPU8){let s=t;for(let i=0;i<4;i++)r[e+i]=255&s,s=s>>8}function l(e){if(!e.startsWith("/"))return;let t=e.substring(1).split("/");for(let r=1;r<=t.length;r++){let s="/"+t.slice(0,r).join("/");h(s)||FS.mkdir(s)}}function h(e){try{return FS.stat(e),!0}catch(t){return!1}}function b(e){try{return FS.readFile(e)}catch(t){console.trace(t)}}function k(e,t,r={}){try{switch(e){case"mem":FS.mount(MEMFS,r,t);break;case"worker":FS.mount(WORKERFS,r,t);break}}catch(s){console.trace(s)}}var d,C=new Uint8Array(16);function v(){if(!d&&(d=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!d))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return d(C)}var R=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Q(e){return typeof e=="string"&&R.test(e)}var w=Q;var n=[];for(c=0;c<256;++c)n.push((c+256).toString(16).substr(1));var c;function E(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase();if(!w(r))throw TypeError("Stringified UUID is invalid");return r}var P=E;function U(e,t,r){e=e||{};var s=e.random||(e.rng||v)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){r=r||0;for(var i=0;i<16;++i)t[r+i]=s[i];return t}return P(s)}var a=U;function p(){let e=s=>{},t=s=>{},r=new Promise((s,i)=>{e=s,t=i});return Object.assign(r,{resolve:e,reject:t})}var M=class{constructor(){this._string=new Map;this._void=new Map;this._strings=new Map;this._file=new Map;this._files=new Map;this.onMessage=t=>{if(A(t.data)){let r=t.data.id,s=t.data.value,i=this._string.get(r);this._string.delete(r),i==null||i.resolve(s)}else if(L(t.data)){let r=t.data.id,s=this._void.get(r);this._void.delete(r),s==null||s.resolve()}else if(K(t.data)){let r=t.data.id,s=this._strings.get(r);this._strings.delete(r),s==null||s.resolve(t.data.strings)}else if(T(t.data)){let r=t.data.id,s=this._file.get(r);this._file.delete(r),s==null||s.resolve(t.data.file)}else if(j(t.data)){let r=t.data.id,s=this._files.get(r);this._files.delete(r),s==null||s.resolve(t.data.files)}};self.addEventListener("message",this.onMessage)}async get(t){let r=a(),s=p(),i={type:"get",id:r,key:t};return this._string.set(r,s),self.postMessage(i),s.then(async o=>{if(o===void 0)return;let f=await(await fetch(o)).arrayBuffer();return new Uint8Array(f)})}async file_(t){let r=a(),s=p(),i={type:"file",id:r,key:t};return this._file.set(r,s),self.postMessage(i),s}async put(t,r){let s=a(),i=p(),o={type:"put",id:s,key:t,buffer:r};return this._void.set(s,i),self.postMessage(o),i}async del(t){let r=a(),s=p(),i={type:"del",id:r,key:t};return this._void.set(r,s),self.postMessage(i),s}async keys({withPrefix:t}){let r=a(),s=p(),i={type:"keys_with_prefix",id:r,prefix:t};return this._strings.set(r,s),self.postMessage(i),s}async files({withPrefix:t}){let r=a(),s=p(),i={type:"files_with_prefix",id:r,prefix:t};return this._files.set(r,s),self.postMessage(i),s}async removeKeys({withPrefix:t}){let r=a(),s=p(),i={id:r,prefix:t,type:"remove_keys_with_prefix"};return this._void.set(r,s),self.postMessage(i),s}};function j(e){return e?e.type==="files_response"&&typeof e.id=="string"&&!!e.files:!1}function A(e){return e?e.type==="string_response"&&typeof e.id=="string":!1}function L(e){return e?e.type==="void_response"&&typeof e.id=="string":!1}function K(e){return e?e.type==="strings_response"&&typeof e.id=="string"&&!!e.strings:!1}function T(e){return e?e.type==="file_response"&&typeof e.id=="string":!1}async function S({kvs:e,prefix:t,mountPoint:r}){let s=t.endsWith("/")?t:`${t}/`,o=(await e.files({withPrefix:s})).map(u=>{let f=u.file,g=f.name.substring(s.length);return new File([f],g)});l(r),k("worker",r,{files:o})}self.importScripts("./region-wasm.js");self.addEventListener("message",e=>{F(e.data)&&V(e.data)});var W=new M;function V(e){$(e).catch(console.error)}async function $(e){let{id:t,rx:r,rz:s,dim:i,javaEditionMap:o}=e;h("/wfs")||await S({kvs:W,prefix:`/je2be/${t}/in`,mountPoint:"/wfs"});let u="/wfs";i===1?u="/wfs/DIM-1":i===2&&(u="/wfs/DIM1");let f=Module._malloc(o.length*4);for(let y=0;y<o.length;y++)x(f+y*4,o[y]);let g=`/je2be/${t}/wd/${i}`;if(l(g),!Module.ConvertRegion(t,u,r,s,i,f,o.length)){console.error(`[region] (${t}) ConvertRegion failed`);return}let m=`${g}/r.${r}.${s}.nbt`,_=b(m);if(!_)throw new Error(`Cannot read file ${m}`);await W.put(m,_),Module.RemoveAll("/je2be");let D={type:"region_done",id:t};self.postMessage(D)}})();
