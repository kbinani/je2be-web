(()=>{function w(e){return e?e.type==="region"&&typeof e.id=="string"&&typeof e.rx=="number"&&typeof e.rz=="number"&&typeof e.dim=="number"&&!!e.javaEditionMap:!1}function k(e,t,r=Module.HEAPU8){let s=t;for(let i=0;i<4;i++)r[e+i]=255&s,s=s>>8}function l(e){if(!e.startsWith("/"))return;let t=e.substring(1).split("/");for(let r=1;r<=t.length;r++){let s="/"+t.slice(0,r).join("/");d(s)||FS.mkdir(s)}}function d(e){try{return FS.stat(e),!0}catch(t){return!1}}async function R(e,t){let r=async s=>{let{path:i,node:o}=s;if(o.isFolder){await t({path:i,dir:!0});for(let a of Object.keys(o.contents)){let f=o.contents[a],y=`${i}/${a}`;await r({path:y,node:f})}}else{if(o.isDevice)return;await t({path:i,dir:!1})}};d(e)&&await r(FS.lookupPath(e))}function M(e){try{return FS.readFile(e)}catch(t){console.trace(t)}}function P(e,t,r={}){try{switch(e){case"mem":FS.mount(MEMFS,r,t);break;case"worker":FS.mount(WORKERFS,r,t);break}}catch(s){console.trace(s)}}var c,U=new Uint8Array(16);function _(){if(!c&&(c=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!c))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return c(U)}var S=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function j(e){return typeof e=="string"&&S.test(e)}var W=j;var n=[];for(m=0;m<256;++m)n.push((m+256).toString(16).substr(1));var m;function A(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase();if(!W(r))throw TypeError("Stringified UUID is invalid");return r}var D=A;function L(e,t,r){e=e||{};var s=e.random||(e.rng||_)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){r=r||0;for(var i=0;i<16;++i)t[r+i]=s[i];return t}return D(s)}var p=L;function g(){let e=s=>{},t=s=>{},r=new Promise((s,i)=>{e=s,t=i});return Object.assign(r,{resolve:e,reject:t})}var h=class{constructor(){this._string=new Map;this._void=new Map;this._strings=new Map;this._file=new Map;this._files=new Map;this.onMessage=t=>{if(T(t.data)){let r=t.data.id,s=t.data.value,i=this._string.get(r);this._string.delete(r),i==null||i.resolve(s)}else if(K(t.data)){let r=t.data.id,s=this._void.get(r);this._void.delete(r),s==null||s.resolve()}else if(V(t.data)){let r=t.data.id,s=this._strings.get(r);this._strings.delete(r),s==null||s.resolve(t.data.strings)}else if(O(t.data)){let r=t.data.id,s=this._file.get(r);this._file.delete(r),s==null||s.resolve(t.data.file)}else if($(t.data)){let r=t.data.id,s=this._files.get(r);this._files.delete(r),s==null||s.resolve(t.data.files)}};self.addEventListener("message",this.onMessage)}async get(t){let r=p(),s=g(),i={type:"get",id:r,key:t};return this._string.set(r,s),self.postMessage(i),s.then(async o=>{if(o===void 0)return;let f=await(await fetch(o)).arrayBuffer();return new Uint8Array(f)})}async file_(t){let r=p(),s=g(),i={type:"file",id:r,key:t};return this._file.set(r,s),self.postMessage(i),s}async put(t,r){let s=p(),i=g(),o={type:"put",id:s,key:t,buffer:r};return this._void.set(s,i),self.postMessage(o),i}async del(t){let r=p(),s=g(),i={type:"del",id:r,key:t};return this._void.set(r,s),self.postMessage(i),s}async keys({withPrefix:t}){let r=p(),s=g(),i={type:"keys_with_prefix",id:r,prefix:t};return this._strings.set(r,s),self.postMessage(i),s}async files({withPrefix:t}){let r=p(),s=g(),i={type:"files_with_prefix",id:r,prefix:t};return this._files.set(r,s),self.postMessage(i),s}async removeKeys({withPrefix:t}){let r=p(),s=g(),i={id:r,prefix:t,type:"remove_keys_with_prefix"};return this._void.set(r,s),self.postMessage(i),s}};function $(e){return e?e.type==="files_response"&&typeof e.id=="string"&&!!e.files:!1}function T(e){return e?e.type==="string_response"&&typeof e.id=="string":!1}function K(e){return e?e.type==="void_response"&&typeof e.id=="string":!1}function V(e){return e?e.type==="strings_response"&&typeof e.id=="string"&&!!e.strings:!1}function O(e){return e?e.type==="file_response"&&typeof e.id=="string":!1}async function C({kvs:e,prefix:t,mountPoint:r}){let s=t.endsWith("/")?t:`${t}/`,o=(await e.files({withPrefix:s})).map(a=>{let f=a.file,y=f.name.substring(s.length);return new File([f],y)});l(r),P("worker",r,{files:o})}self.importScripts("./region-wasm.js");self.addEventListener("message",e=>{w(e.data)&&z(e.data)});var F=new h;function z(e){I(e).catch(console.error)}async function I(e){let{id:t,rx:r,rz:s,dim:i,javaEditionMap:o}=e;d("/wfs")||await C({kvs:F,prefix:`/je2be/${t}/in`,mountPoint:"/wfs"});let a="/wfs";i===1?a="/wfs/DIM-1":i===2&&(a="/wfs/DIM1");let f=Module._malloc(o.length*4);for(let u=0;u<o.length;u++)k(f+u*4,o[u]);let y=`/je2be/${t}/wd/${i}`;if(l(y),!Module.ConvertRegion(t,a,r,s,i,f,o.length)){console.error(`[region] (${t}) ConvertRegion failed`);return}let v=`${y}/r.${r}.${s}.nbt`,x=M(v);if(!x)throw new Error(`Cannot read file ${v}`);await F.put(v,x),await R(`/je2be/${t}/entities/${i}`,async({path:u,dir:E})=>{if(E)return;let b=M(u);if(!b)throw new Error(`Cannot read file ${u}`);await F.put(u,b)}),Module.RemoveAll("/je2be");let Q={type:"region_done",id:t};self.postMessage(Q)}})();
